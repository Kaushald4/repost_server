generator client {
  provider     = "prisma-client"
  output       = "../generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

/**
 * ============================
 * ENUMS
 * ============================
 */

enum CommunityVisibility {
  PUBLIC // anyone can view & follow
  RESTRICTED // visible, join requires approval
  PRIVATE // invite-only
}

enum CommunityStatus {
  ACTIVE
  SUSPENDED
  ARCHIVED
}

enum CommunityMemberStatus {
  PENDING
  ACTIVE
  BANNED
}

enum CommunityModeratorRole {
  OWNER
  MODERATOR
}

enum CommunityModeratorStatus {
  INVITED
  ACTIVE
  REJECTED
  REMOVED
}

/**
 * ============================
 * CORE MODELS
 * ============================
 */

model Community {
  id          String  @id @default(cuid())
  name        String  @unique
  title       String
  description String?

  visibility CommunityVisibility @default(PUBLIC)
  status     CommunityStatus     @default(ACTIVE)

  ownerId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  isDeleted Boolean   @default(false)
  deletedAt DateTime?

  /**
   * Relations
   */
  icon       Icon?
  banner     Banner?
  members    CommunityMember[]
  moderators CommunityModerator[]
  rules      CommunityRule[]
  followers  CommunityFollow[]

  @@unique([createdAt, id])
}

/**
 * ============================
 * MEDIA (STRICT ONE-TO-ONE)
 * ============================
 */

model Banner {
  id     String @id @default(cuid())
  url    String
  fileId String @unique

  communityId String    @unique
  community   Community @relation(fields: [communityId], references: [id])
}

model Icon {
  id     String @id @default(cuid())
  url    String
  fileId String @unique

  communityId String    @unique
  community   Community @relation(fields: [communityId], references: [id])
}

/**
 * ============================
 * MEMBERSHIP
 * ============================
 */

model CommunityMember {
  id          String    @id @default(cuid())
  communityId String
  community   Community @relation(fields: [communityId], references: [id])

  userId String

  status   CommunityMemberStatus @default(ACTIVE)
  joinedAt DateTime              @default(now())
  leftAt   DateTime?
  bannedAt DateTime?

  @@unique([communityId, userId])
  @@index([communityId])
  @@index([userId])
}

/**
 * ============================
 * MODERATION
 * ============================
 */

model CommunityModerator {
  id          String    @id @default(cuid())
  communityId String
  community   Community @relation(fields: [communityId], references: [id])

  userId String

  role CommunityModeratorRole @default(MODERATOR)

  status CommunityModeratorStatus @default(INVITED)

  invitedAt   DateTime  @default(now())
  respondedAt DateTime?

  @@unique([communityId, userId])
}

/**
 * ============================
 * RULES
 * ============================
 */

model CommunityRule {
  id          String    @id @default(cuid())
  communityId String
  community   Community @relation(fields: [communityId], references: [id])

  text  String
  order Int
}

/**
 * ============================
 * FOLLOWERS (INTEREST GRAPH)
 * ============================
 */

model CommunityFollow {
  id          String    @id @default(cuid())
  communityId String
  community   Community @relation(fields: [communityId], references: [id])

  userId String

  createdAt    DateTime  @default(now())
  unfollowedAt DateTime?

  @@unique([communityId, userId])
  @@index([communityId])
  @@index([userId])
}
